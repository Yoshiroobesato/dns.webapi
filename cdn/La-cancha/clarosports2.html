<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming en Vivo Ultra Avanzado con Shaka Player</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #video-container { width: 100%; height: 100%; }
        video { width: 100%; height: 100%; }
        #error-overlay { 
            display: none; 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            justify-content: center; 
            align-items: center; 
            font-family: Arial, sans-serif; 
        }
        #stats { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); padding: 5px; font-family: monospace; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
</head>
<body>
    <div id="video-container">
        <video id="video" controls autoplay></video>
    </div>
    <div id="error-overlay">
        <div>Error en la reproducci√≥n. Intentando reconectar...</div>
    </div>
    <div id="stats"></div>

    <script>
        const manifestUri = 'https://update8915.pricesaskeloadsc.com:443/global/clarosports2/index.m3u8?token=c639897a3fe493212f3e66816683cc94a32b0d57-41-1723287124-1723251124';
        const video = document.getElementById('video');
        const errorOverlay = document.getElementById('error-overlay');
        const statsDiv = document.getElementById('stats');

        function initApp() {
            shaka.polyfill.installAll();
            if (shaka.Player.isBrowserSupported()) {
                initPlayer();
            } else {
                console.error('Browser not supported!');
            }
        }

        async function initPlayer() {
            const player = new shaka.Player(video);

            player.configure({
                streaming: {
                    bufferingGoal: 30,
                    rebufferingGoal: 15,
                    bufferBehind: 30,
                    lowLatencyMode: true,
                    jumpLargeGaps: true,
                    retryParameters: {
                        maxAttempts: 10,
                        baseDelay: 1000,
                        backoffFactor: 2,
                        fuzzFactor: 0.5,
                        timeout: 30000,
                    }
                },
                abr: {
                    enabled: true,
                    defaultBandwidthEstimate: 1000000,
                    switchInterval: 8,
                    bandwidthUpgradeTarget: 0.85,
                    bandwidthDowngradeTarget: 0.95,
                }
            });

            player.addEventListener('error', onPlayerErrorEvent);

            try {
                await player.load(manifestUri);
                console.log('The video has now been loaded!');
                updateStats(player);
                setInterval(() => updateStats(player), 1000);
            } catch (error) {
                onPlayerError(error);
            }

            video.addEventListener('play', () => {
                errorOverlay.style.display = 'none';
            });
        }

        function onPlayerErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function onPlayerError(error) {
            console.error('Error code', error.code, 'object', error);
            errorOverlay.style.display = 'flex';
            setTimeout(() => initPlayer(), 5000);
        }

        function updateStats(player) {
            const stats = player.getStats();
            statsDiv.textContent = `
                Bandwidth: ${Math.round(stats.estimatedBandwidth / 1000)} kbps
                Buffer: ${Math.round(stats.bufferingTime * 10) / 10}s
                Dropped Frames: ${stats.droppedFrames}
                Current Resolution: ${stats.width}x${stats.height}
            `;
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>